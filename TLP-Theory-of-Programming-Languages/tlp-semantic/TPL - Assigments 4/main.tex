\documentclass{article}

% Language setting
% Replace `english' with e.g. `spanish' to change the document language
\usepackage[english]{babel}

% Set page size and margins
% Replace `letterpaper' with`a4paper' for UK/EU standard size
\usepackage[letterpaper,top=2cm,bottom=2cm,left=3cm,right=3cm,marginparwidth=1.75cm]{geometry}

% Useful packages
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{graphicx}
\usepackage{stmaryrd}
\usepackage[colorlinks=true, allcolors=blue]{hyperref}
\usepackage{amssymb}
\usepackage{ebproof}
\newcommand{\rep}{\texttt{repeat $S$ until $b$ }}
\newcommand{\for}{\texttt{for $x:=e_1$ to $e_2$ do $S$ }}
\newcommand{\forp}{\texttt{for $x:=e_1 + 1$ to $e_2$ do $S$ }}
\newcommand{\whl}{\texttt{$S$; while $\neg b$ do $S$}}
\newcommand{\while}{\texttt{while $n>0$ do $(x:=2 * x;n:=n-1)$}}
\newcommand{\whileneg}{\texttt{while $\neg b$ do $S$}}
\newcommand{\qed}{\begin{flushright}\rule{0.7em}{0.7em}\end{flushright}}
\newcommand{\sangle}[2]{\langle #1, #2 \rangle}
\newcommand{\bigs}[3]{\sangle{#1}{#2}\Downarrow #3}
\newcommand{\smalls}[3]{\sangle{#1}{#2} \longrightarrow #3}
\newcommand{\bcal}{\mathcal{B}}
\newcommand{\scal}{\mathcal{S}}
\newcommand{\bool}[1]{\bcal \llbracket #1 \rrbracket}
\newcommand{\sem}[1]{\scal \llbracket #1 \rrbracket}


\title{}
\date{}
\author{Rafael FernÃ¡ndez Ortiz}

\begin{document}
\maketitle

\section*{Assignments 3}
\subsection*{Exercise 4}
\begin{enumerate}
\item[] Given the function $F: (State \rightarrow State_{\perp}) \longrightarrow  (State \rightarrow State_{\perp})$ defined as follows: $$F(f) = cond(\bool{n > 0}, f \circ \sem{x:=2 * x; n:= n-1},id)$$

\begin{enumerate}
    \item Give an explicit definition for $F(\lambda\sigma.\perp)$, $F^2(\lambda\sigma.\perp)$ and $F^3(\lambda\sigma.\perp)$.
    \item From the results above, conjecture a general definition for $F^i(\lambda\sigma.\perp)$ where $i \geq 1$.\;\; \; [Optional] Prove by induction on $i$ that your conjecture is correct.
    \item Give an explicit definition for $\bigsqcup_i F^i(\lambda\sigma.\perp)$.
    \item Which is the least fixed point of F? Justify your answer.
    \item Given the above, compute the state resulting from the execution of the following program $$x:=1;\while$$ under the initial stage $\sigma = [n \rightarrow 4]$.
\end{enumerate}
\end{enumerate}
\subsubsection*{a) An explicit definition for $F(\lambda\sigma.\perp)$, $F^2(\lambda\sigma.\perp)$ and $F^3(\lambda\sigma.\perp)$}
Let $F: (State \rightarrow State_{\perp}) \longrightarrow  (State \rightarrow State_{\perp})$ be a function defined as follow $$F(f) = cond(\bool{n > 0}, f \circ \sem{S},id)$$ where $S = (x:=2 * x; n:= n-1)$.\\\\
Let us consider $f_0: State \longrightarrow State_{\perp}$, $f_0 = \lambda \sigma .\perp$ for all $\sigma$. We will define explicitly  $f_1 = F(f_0)$, $f_1 = F^2(f_0)$ and $f_3 = F^3(f_0)$:\\

%%%% Definicion de F(f0)
\subsubsection*{Definition of $F(f_0)$}
Let us consider a function $f_1: State \longrightarrow State_{\perp}$ defined as follow
\begin{align*}
f_1 := F(f_0) &= cond(\bool{n > 0}, f_0 \circ \sem{S},id) \\ \\
& = \lambda \sigma . \left\{
\begin{array}{ll}
      f_0 \circ \sem{S} \; \sigma & \bool{n>0} \sigma\\
      \\ \\
      id \; \sigma & \bool{n \leq 0} \sigma \\
\end{array} 
\right. \\ \\
& = \lambda \sigma . \left\{
\begin{array}{ll}
      f_0 \circ \sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow \sigma(n)-1] & \sigma(n) > 0 \\
      \\ \\
      \sigma & \sigma(n) \leq 0 \\
\end{array} 
\right.\\
\end{align*}
but since $f_0 = \lambda \sigma . \perp$ $\forall \sigma$, then $ f_0 \circ \sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow \sigma(n)-1] = \perp$ for all $\sigma$. Therefore \\
\begin{align}
f_1 = F(f_0) &= \lambda \sigma . \left\{
\begin{array}{ll}
      \perp & \sigma(n) > 0 \\
      \\ \\
      \sigma & \sigma(n) \leq 0 \\
\end{array} 
\right.
\end{align}
%%%% Definicion de F(f1)
\subsubsection*{Definition of $F^2(f_0)$}
Let us consider a function $f_2: State \longrightarrow State_{\perp}$ defined as follow

\begin{align*}
f_2 := F^2(f_0) =  F(f_1) &= cond(\bool{n > 0}, f_1 \circ \sem{S},id) \\ \\
& = \lambda \sigma . \left\{
\begin{array}{ll}
      f_1 \circ \sem{S} \; \sigma & \bool{n>0} \sigma\\
      \\ \\
      id \; \sigma & \bool{n \leq 0} \sigma \\
\end{array} 
\right. \\ \\
& = \lambda \sigma . \left\{
\begin{array}{ll}
      f_1 \circ \sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow \sigma(n)-1] & \sigma(n) > 0 \\
      \\ \\
      \sigma & \sigma(n) \leq 0 \\
\end{array} 
\right.\\
\end{align*}
we know now that (1) $f_1 = \lambda \sigma_1 . \perp$ if $\sigma_1(n) > 0$ and $f_1 = \lambda \sigma_1 . \sigma_1$ (the identity) if $\sigma_1(n) \leq 0$, being more precise $f_1 = \lambda \sigma_1 . \sigma_1$ either $\sigma_1(n) = 0$ or $\sigma_1(n) < 0$, i.e.:\\
\begin{align*}
f_1 &= \lambda \sigma_1 . \left\{
\begin{array}{ll}
      \perp & \sigma_1(n) > 0 \\
      \\ \\
      \sigma_1 & \sigma_1(n) = 0 \\
      \\ \\
      \sigma_1 & \sigma_1(n) < 0 \\
\end{array} 
\right.
\end{align*}
So, in order to compose $f_1$ with $\sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow \sigma(n)-1]$, we have to distinguish two cases when $\sigma_1(n) > 0$ and $\sigma_1(n) = 0$, i.e. when $\sigma(n)-1 > 0$, and $\sigma(n)-1 = 0$, respectively.\\ \\
The first one is actually easy, $\sigma_1(n) > 0 \iff \sigma(n)-1 > 0 \iff \sigma(n) > 1$ then\begin{align*}
f_2  &= \lambda \sigma . \left.
\begin{array}{ll}
      \perp, & \sigma(n) > 1 \\
\end{array} 
\right.
\end{align*}
In the second one $\sigma_1(n) = 0 \iff \sigma(n)-1 = 0 \iff \sigma(n) = 1$, then
\begin{align*}
f_2  &= \lambda \sigma . \left.
\begin{array}{ll}
      \sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow 0], & \sigma(n) = 1 \\
\end{array} 
\right.
\end{align*}
And finally in the case $\sigma(n) \leq 0$, $f_2 = \lambda \sigma . \sigma$. Therefore \\
\begin{align}
f_2 &= \lambda \sigma . \left\{
\begin{array}{ll}
      \perp & \sigma(n) > 1 \\
      \\ \\
      \sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow 0] & \sigma(n) = 1 \\
      \\ \\
      \sigma & \sigma(n) \leq 0 \\
\end{array} 
\right.
\end{align}
%%%% Definicion de F(f3)
\subsubsection*{Definition of $F^3(f_0)$}
Let us consider a function $f_3: State \longrightarrow State_{\perp}$ defined as follow

\begin{align*}
f_3 := F^3(f_0) = F^2(f_1) = F(f_2) &= cond(\bool{n > 0}, f_2 \circ \sem{S},id) \\ \\
& = \lambda \sigma . \left\{
\begin{array}{ll}
      f_2 \circ \sem{S} \; \sigma & \bool{n>0} \sigma\\
      \\ \\
      id \; \sigma & \bool{n \leq 0} \sigma \\
\end{array} 
\right. \\ \\
& = \lambda \sigma . \left\{
\begin{array}{ll}
      f_2 \circ \sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow \sigma(n)-1] & \sigma(n) > 0 \\
      \\ \\
      \sigma & \sigma(n) \leq 0 \\
\end{array} 
\right.\\
\end{align*}
In  order to proceed with the definition of $f_3$ we will think pretty similar to the way when we defined $f_2$, we know that (2) $f_2 = \lambda \sigma_2 . \perp$ if $\sigma_2(n) > 1$, $f_2 = \lambda \sigma_2 . \sigma_2[x\rightarrow 2 \cdot \sigma_2(x), n \rightarrow 0]$ if $\sigma_2(n)=1$ and $f_2 = \lambda \sigma_2 . \sigma_2$ (the identity) if $\sigma_2(n) \leq 0$, being more precise $f_2 = \lambda \sigma_2 . \sigma_2$ either $\sigma_2(n) = 0$ or $\sigma_2(n) < 0$, i.e.:
\begin{align*}
f_2 &= \lambda \sigma_2 . \left\{
\begin{array}{ll}
      \perp & \sigma_2(n) > 1 \\
      \\ \\
      \sigma_2[x\rightarrow 2 \cdot \sigma_2(x), n \rightarrow 0] & \sigma_2(n) = 1 \\
      \\ \\
      \sigma_2 & \sigma_2(n) = 0 \\
      \\ \\
      \sigma_2 & \sigma_2(n) < 0 \\
\end{array} 
\right.
\end{align*}
Again, when $\sigma(n)>0$, we will compose $f_2$ with $\sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow \sigma(n)-1]$. Then, we have to distinguish three cases when $\sigma_2(n) > 1$, $\sigma_2(n) = 1$ and $\sigma_2(n) = 0$, i.e. when $\sigma(n)-1 > 1$, $\sigma(n)-1 = 1$ and $\sigma(n)-1 = 0$, respectively.\\ \\
The first one is actually easy, $\sigma_2(n) > 1 \iff \sigma(n)-1 > 1 \iff \sigma(n) > 2$ then\begin{align*}
f_3  &= \lambda \sigma . \left.
\begin{array}{ll}
      \perp, & \sigma(n) > 2 \\
\end{array} 
\right.
\end{align*}
The third one $\sigma_2(n) = 0 \iff \sigma(n)-1 = 0 \iff \sigma(n) = 1$ then 
\begin{align*}
f_3  &= \lambda \sigma . \left.
\begin{array}{ll}
      \sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow 0], & \sigma(n) = 1 \\
\end{array} 
\right.
\end{align*}
But in the case when $\sigma_2(n) = 1$, we note that in addition to map $n$ to $2$ by $\sigma$, because $\sigma_2(n) = 1 \iff \sigma(n)-1 = 1 \iff \sigma(n)=2$, we have to compose $$(\lambda \sigma_2 . \sigma_2 [x \rightarrow 2 \cdot \sigma_2(x), n \rightarrow 0]) \; \circ \; (\lambda \sigma . \sigma [x \rightarrow 2 \cdot \sigma(x), n \rightarrow 2])$$\\ \\ \\ \\ \\ \\ \\ \\ \\
In other words,

$$(\lambda \sigma_2 . \sigma_2 [x \rightarrow 2 \cdot \sigma_2(x), n \rightarrow 0]) \; \circ \; (\lambda \sigma . \sigma [x \rightarrow 2 \cdot \sigma(x), n \rightarrow 2])$$
\begin{align*}
&= \lambda \sigma . \sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow 0][x\rightarrow 2 \cdot \sigma(x), n \rightarrow 2] \\ \\
&= \lambda \sigma . \sigma[x\rightarrow 2 \cdot (2 \cdot \sigma(x)), n \rightarrow 0] \\ \\
& = \lambda \sigma . \sigma[x\rightarrow 2 \cdot 2 \cdot \sigma(x), n \rightarrow 0] \\ \\
& = \lambda \sigma . \sigma[x\rightarrow 2^2 \cdot \sigma(x), n \rightarrow 0]
\end{align*}\\
And finally, in the case $\sigma(n) \leq 0$, $f_2 = \lambda \sigma . \sigma$. Therefore\\
\begin{align}
f_3 &= \lambda \sigma . \left\{
\begin{array}{ll}
      \perp & \sigma(n) > 2 \\
      \\ \\
      \sigma[x\rightarrow 2^2 \cdot \sigma(x), n \rightarrow 0] & \sigma(n) = 2 \\
    \\ \\
      \sigma[x\rightarrow 2 \cdot \sigma(x), n \rightarrow 0] & \sigma(n) = 1 \\
      \\ \\
      \sigma & \sigma(n) \leq 0 \\
\end{array} 
\right.
\end{align}

\subsubsection*{b) An explicit definition for $F^i(\lambda\sigma.\perp)$.}
Let us consider a function $f_i: State \longrightarrow State_{\perp}$ defined as follow
\begin{align*}
f_i := F^i(\lambda\sigma.\perp) &= \lambda \sigma . \left\{
\begin{array}{ll}
      \perp & \sigma(n) \geq i \\
      \\ \\
      \sigma[x\rightarrow 2^{\sigma(n)} \cdot \sigma(x), n \rightarrow 0] & 0 < \sigma(n) < i \\
      \\ \\
      \sigma & \sigma(n) \leq 0 \\
\end{array} 
\right.
\end{align*}
%\subsubsection*{Proof.} TODO
\subsubsection*{c) An explicit definition for $\bigsqcup_i F^i(\lambda\sigma.\perp)$.}
\begin{align*}
\bigsqcup_i F^i(\lambda\sigma.\perp) &= \lambda \sigma . \left\{
\begin{array}{ll}
      \sigma[x\rightarrow 2^{\sigma(n)} \cdot \sigma(x), n \rightarrow 0] & \sigma(n) > 0 \\
      \\ \\
      \sigma & \sigma(n) \leq 0 \\
\end{array} 
\right.
\end{align*}
\subsubsection*{d) Give the least fixed point of $F$ and justify it.}

Let $(State \rightarrow State_{\perp}, \sqsubseteq)$ be a pair of a set and an order relation, we know that $(State \rightarrow State_{\perp}, \sqsubseteq)$ is a ccpo (proposition pag. 110), and let $F: (State \rightarrow State_{\perp}) \longrightarrow (State \rightarrow State_{\perp})$ be a function with $F(f) = cond(\bool{b}, f \circ \sem{S},id)$ with $S \in Stm$ and $b \in BExp$, we also know $F$ is monotone and continuous in $(State \rightarrow State_{\perp}, \sqsubseteq)$ (result in pag 116).\\\\
Applying Fixed-Point theorem we conclude that $\bigsqcup_i F^i(\lambda\sigma.\perp)$ is the least fixed point of the function $F$, i.e\\
\begin{align*}
lfp\;F = \bigsqcup_i F^i(\lambda\sigma.\perp) &= \lambda \sigma . \left\{
\begin{array}{ll}
      \sigma[x\rightarrow 2^{\sigma(n)} \cdot \sigma(x), n \rightarrow 0] & \sigma(n) > 0 \\
      \\ \\
      \sigma & \sigma(n) \leq 0 \\
\end{array} 
\right.
\end{align*}\\
\subsubsection*{d) Execute the program of d) under the given initial state.}
Let us consider the following statement $$S = (x:=1;\while)$$ and the initial state $\sigma = [n \rightarrow 4]$.\\\\
In order to compute $S$ under $\sigma$ we have to compose $\sigma$ with $\sem{S}$, i.e. $$\sigma \circ \sem{(x:=1;\while)}$$
We know the semantics of a sequence $S_1;S_2$ is defined as follows: $$\sem{S_1;S_2} = \sem{S_2} \circ \sem{S_1}$$ Therefore, we obtain that  $$\sem{x:=1;\while} = \sem{\while} \; \circ \; \sem{x:=1}$$
And finally
\begin{align*}
\sigma \circ \sem{S} &= \sigma \circ \sem{(x:=1;\while)} \\ \\
& = \sigma \circ \sem{\while} \; \circ \sem{x:=1} \\ \\
& = \sigma \circ \sem{\while} \; [x \rightarrow 1 ] \\ \\
& = [n \rightarrow 4] \circ \sem{\while} \; [x \rightarrow 1 ] \\ \\
& = \sem{\while} \; [x \rightarrow 1 ] [n \rightarrow 4]\\ \\
& = \sem{\while} \; [x \rightarrow 1, n \rightarrow 4]\\ \\
& = (lfp \; F) \; [x \rightarrow 1, n \rightarrow 4]\\ \\
& = \left( \bigsqcup_i F^i(\lambda\sigma.\perp) \right) \; [x \rightarrow 1, n \rightarrow 4]\\ \\
& = \lambda \sigma' . \sigma'[x \rightarrow 2^4, n \rightarrow 0] \\ \\
& = \lambda \sigma' . \sigma'[x \rightarrow 16, n \rightarrow 0]
\end{align*}\\
\end{document}